<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encryption</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #1a1a1a;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #a0a0a0;
        }
        .input, .textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #333333;
            border: 1px solid #444444;
            color: #ffffff;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input:focus, .textarea:focus {
            outline: none;
            border-color: #6a6a6a;
            box-shadow: 0 0 0 2px rgba(106, 106, 106, 0.5);
        }
        .textarea {
            resize: vertical;
            min-height: 150px;
        }
        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
        }
        .btn {
            flex-grow: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            border: none;
        }
        .btn-primary {
            background-color: #6d28d9;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #5b21aa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(109, 40, 217, 0.3);
        }
        .btn-secondary {
            background-color: #3f3f46;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #52525b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(63, 63, 70, 0.3);
        }
        .result-box {
            background-color: #0d0d0d;
            border: 1px solid #2a2a2a;
            padding: 1rem;
            border-radius: 0.5rem;
            word-break: break-all;
            margin-top: 1.5rem;
        }
        .result-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #a0a0a0;
        }
        .result-text {
            color: #cccccc;
        }
        .message-box {
            background-color: #2c2c2c;
            color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            text-align: center;
            animation: slideIn 0.3s ease-out;
            display: none;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-black text-white">

<div class="container">
    <h1 class="text-3xl font-bold text-center mb-8">Encryption</h1>

    <div class="form-group">
        <label for="message" class="label">Message:</label>
        <textarea id="message" class="textarea" placeholder="Enter your message here..."></textarea>
    </div>

    <div class="form-group">
        <label for="password" class="label">Password:</label>
        <input type="password" id="password" class="input" placeholder="Enter a password...">
    </div>

    <div class="btn-group">
        <button id="encryptBtn" class="btn btn-primary">Encrypt</button>
        <button id="decryptBtn" class="btn btn-secondary">Decrypt</button>
    </div>

    <div id="resultBox" class="result-box hidden mt-6">
        <div class="result-title">Result:</div>
        <div id="resultText" class="result-text"></div>
    </div>
    
    <div id="messageBox" class="message-box"></div>
</div>

<script>
    // Utility function to convert a string to a Uint8Array
    function strToUint8(str) {
        return new TextEncoder().encode(str);
    }

    // Utility function to convert a Uint8Array to a string
    function uint8ToStr(uint8) {
        return new TextDecoder().decode(uint8);
    }

    // Utility function to convert ArrayBuffer to Base64 string
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    // Utility function to convert Base64 string to ArrayBuffer
    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Displays a message to the user for a short period
    function showMessage(text, isError = false) {
        const messageBox = document.getElementById('messageBox');
        messageBox.textContent = text;
        messageBox.style.display = 'block';
        if (isError) {
            messageBox.style.backgroundColor = '#ef4444'; // Red for errors
        } else {
            messageBox.style.backgroundColor = '#2c2c2c'; // Dark gray for success/info
        }
        messageBox.style.animation = 'slideIn 0.3s ease-out';
        setTimeout(() => {
            messageBox.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 300);
        }, 3000);
    }

    // Function to derive a key from the user's password using PBKDF2
    async function getKey(password) {
        // PBKDF2 salt should be unique per key, but for this simple app, we use a fixed salt.
        // In a real-world app, this would be generated and stored with the ciphertext.
        const salt = strToUint8('fixed-salt-for-demo');
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw",
            strToUint8(password),
            { name: "PBKDF2" },
            false,
            ["deriveKey"]
        );
        return window.crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 100000,
                hash: "SHA-256",
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            true,
            ["encrypt", "decrypt"]
        );
    }

    // Function to encrypt the message
    async function encryptMessage(message, password) {
        try {
            // Check if message and password are provided
            if (!message || !password) {
                showMessage("Please enter both a message and a password.", true);
                return;
            }

            const key = await getKey(password);
            const data = strToUint8(message);

            // The IV (Initialization Vector) should be unique for each encryption.
            // For this simple demo, we generate a new one each time.
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const encryptedData = await window.crypto.subtle.encrypt(
                {
                    name: "AES-GCM",
                    iv: iv,
                },
                key,
                data
            );

            // Combine the IV and encrypted data into a single string for storage/transfer
            const combined = new Uint8Array(iv.byteLength + encryptedData.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(encryptedData), iv.byteLength);

            return arrayBufferToBase64(combined);
        } catch (error) {
            console.error("Encryption failed:", error);
            showMessage("Encryption failed. Please try again.", true);
        }
    }

    // Function to decrypt the message
    async function decryptMessage(encryptedMessage, password) {
        try {
            // Check if encrypted message and password are provided
            if (!encryptedMessage || !password) {
                showMessage("Please enter both the encrypted message and the password.", true);
                return;
            }

            const key = await getKey(password);
            const combined = base64ToArrayBuffer(encryptedMessage);

            // Separate the IV and the encrypted data
            const iv = combined.slice(0, 12);
            const encryptedData = combined.slice(12);

            const decryptedData = await window.crypto.subtle.decrypt(
                {
                    name: "AES-GCM",
                    iv: iv,
                },
                key,
                encryptedData
            );

            return uint8ToStr(new Uint8Array(decryptedData));
        } catch (error) {
            console.error("Decryption failed:", error);
            showMessage("Decryption failed. Incorrect password or corrupted message.", true);
        }
    }

    // Event listeners for the buttons
    document.getElementById('encryptBtn').addEventListener('click', async () => {
        const messageInput = document.getElementById('message');
        const passwordInput = document.getElementById('password');
        const resultBox = document.getElementById('resultBox');
        const resultText = document.getElementById('resultText');

        const encrypted = await encryptMessage(messageInput.value, passwordInput.value);
        if (encrypted) {
            resultText.textContent = encrypted;
            resultBox.classList.remove('hidden');
            messageInput.value = ''; // Clear the message input after encryption
            showMessage("Message encrypted successfully!");
        }
    });

    document.getElementById('decryptBtn').addEventListener('click', async () => {
        const messageInput = document.getElementById('message');
        const passwordInput = document.getElementById('password');
        const resultBox = document.getElementById('resultBox');
        const resultText = document.getElementById('resultText');

        const decrypted = await decryptMessage(messageInput.value, passwordInput.value);
        if (decrypted) {
            resultText.textContent = decrypted;
            resultBox.classList.remove('hidden');
            messageInput.value = ''; // Clear the message input after decryption
            showMessage("Message decrypted successfully!");
        }
    });

</script>

</body>
</html>
